parameters:
- name: 'backendServiceArm'  # $(Subscription)
  type: string
- name: 'workingDirectory'  # $(Pipeline.Workspace)/drop
  type: string
- name: 'environment'  # 'dev'
  type: string
- name: 'backendAzureRmResourceGroupName' # $(Tf.ResourceGroup)
  type: string
- name: 'backendAzureRmStorageAccountName' # $(Tf.StorageAccount)
  type: string
- name: 'backendAzureRmContainerName' # $(Tf.Container)
  type: string
- name: 'backendAzureRmKey' # $(Tf.Statefile)
  type: string

steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
displayName: 'Install Terraform 0.12.23'
inputs:
    terraformVersion: 0.12.23

- task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV1@0
displayName: 'Terraform init'
inputs:
    workingDirectory:  ${{parameters.workingDirectory}}
    backendServiceArm: ${{parameters.backendServiceArm}}
    backendAzureRmResourceGroupName: ${{parameters.backendAzureRmResourceGroupName}}
    backendAzureRmStorageAccountName: ${{parameters.backendAzureRmStorageAccountName}}
    backendAzureRmContainerName: ${{parameters.backendAzureRmContainerName}}
    backendAzureRmKey: ${{parameters.backendAzureRmKey}}

- task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV1@0
displayName: 'Terraform plan'
inputs:
    provider: 'azurerm'
    environmentServiceNameAzureRM: ${{parameters.backendServiceArm}}
    command: 'plan'
    commandOptions: '-var-file=${{parameters.environment}}/config.tfvars -var=environment_name=${{parameters.environment}} -out=${{parameters.environment}}.tfplan'
    workingDirectory:  ${{parameters.workingDirectory}}

- task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV1@0
displayName: 'Terraform apply'
inputs:
    provider: 'azurerm'
    environmentServiceNameAzureRM: ${{parameters.backendServiceArm}}
    command: 'apply'
    commandOptions: '${{parameters.environment}}.tfplan'
    workingDirectory:  ${{parameters.workingDirectory}}